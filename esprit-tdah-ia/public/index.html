<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>TDAI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
</head>
<body>

<div class="tdai-app" style="--bg0:#0c0f19;--bg1:#0f1424;--bg2:#121831;--txt:#e9ebf3;--dim:#a7afc7;--brand:#6a7dff;--acc:#5be7c4;--br:#232a4d;--bubU:#0b2c55;--bubA:#161f3d;">
  <style>
    html,body{
      margin:0;padding:0;background:#0c0f19;height:100%;width:100%;
      font-size:clamp(16px,1.8vh + 0.5rem,18px);
      -webkit-text-size-adjust:100%; text-size-adjust:100%;
      overflow:hidden; /* on fait scroller le chat, pas la page */
    }

    :root{--safe-b:env(safe-area-inset-bottom,4px)}

    .tdai-app{
      color:var(--txt);
      font:400 16px/1.6 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,var(--bg0)0%,var(--bg1)60%,var(--bg2)100%);
      width:100%;
      min-height:100dvh;
      display:flex;
    }
    @supports (height: 100svh){ .tdai-app{ min-height:100svh; } }

    .tdai-wrap{flex:1;display:flex;flex-direction:column;width:100%}

    .tdai-top{display:flex;justify-content:space-between;align-items:center;gap:12px;
      padding:12px 16px;border-bottom:1px solid var(--br);position:sticky;top:0;
      background:rgba(12,15,25,.9);backdrop-filter:saturate(120%) blur(8px);z-index:5}
    .tdai-brand{display:flex;align-items:center;gap:10px}
    .tdai-logo{width:36px;height:36px;border-radius:9px;display:grid;place-items:center;font-weight:800;color:#0e1330;
      background:linear-gradient(135deg,var(--brand),var(--acc));box-shadow:0 6px 18px rgba(106,125,255,.35)}
    .tdai-title{margin:0;font-size:18px;font-weight:700}
    .tdai-pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--br);border-radius:999px;
      padding:6px 10px;background:rgba(20,26,52,.6);color:var(--txt);font-size:13px}
    .tdai-dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--acc));box-shadow:0 0 10px var(--acc)}

    /* Zone chat qui scrolle */
    .tdai-chat{
      flex:1;min-height:0;overflow:auto;padding:16px;
      display:flex;flex-direction:column;scroll-behavior:smooth;
      overscroll-behavior:contain;
    }
    .tdai-chat::-webkit-scrollbar{width:10px}
    .tdai-chat::-webkit-scrollbar-thumb{background:#27315e;border-radius:999px}

    /* Messages */
    .tdai-msg{display:flex;gap:10px;margin:10px 0;align-items:flex-end}
    /* IA √† gauche */
    .tdai-msg.assistant{flex-direction:row;justify-content:flex-start}
    /* Utilisateur √† droite */
    .tdai-msg.user{flex-direction:row-reverse;justify-content:flex-end}

    .tdai-ava{flex:0 0 34px;height:34px;border-radius:8px;
      display:grid;place-items:center;font-size:12px;font-weight:700;color:#0f1424}
    .tdai-msg.assistant .tdai-ava{background:linear-gradient(135deg,var(--brand),var(--acc))}
    /* On masque l‚Äôavatar c√¥t√© utilisateur (pas de ‚ÄúToi‚Äù) */
    .tdai-msg.user .tdai-ava{display:none}

    .tdai-bub{
      background:var(--bubA);border:1px solid var(--br);border-radius:14px;
      padding:12px 14px;max-width:90%;
      word-wrap:break-word;white-space:pre-wrap;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      font-size:17px;line-height:1.7
    }
    .tdai-msg.user .tdai-bub{background:linear-gradient(180deg,var(--bubU),#0a2244);border-color:#1b3b72}

    /* Pr√©visualisations images */
    .tdai-previews{display:flex;gap:8px;flex-wrap:wrap;margin:10px 12px}
    .tdai-thumb{position:relative;width:84px;height:84px;border:1px solid var(--br);border-radius:10px;overflow:hidden;background:#0e1530}
    .tdai-thumb img{width:100%;height:100%;object-fit:cover}
    .tdai-x{position:absolute;top:4px;right:4px;width:20px;height:20px;border-radius:50%;background:rgba(0,0,0,.55);color:#fff;border:0;cursor:pointer}

    /* Barre de saisie FIXE en bas */
    .tdai-compose{
      position:fixed;left:0;right:0;bottom:0;z-index:10;
      background:rgba(12,15,25,.96);backdrop-filter:blur(8px);
      padding:10px 10px calc(8px + var(--safe-b));
    }
    .tdai-inwrap{display:flex;gap:10px;align-items:flex-end;background:rgba(20,26,52,.75);border:1px solid var(--br);
      border-radius:16px;padding:10px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .tdai-input{flex:1;min-height:44px;max-height:160px;resize:none;border:0;outline:none;background:transparent;color:var(--txt);padding:6px 8px;font-size:16px}
    .tdai-actions{display:flex;gap:8px;align-items:center}
    .tdai-ibtn{width:40px;height:40px;border:1px solid var(--br);border-radius:12px;background:rgba(15,20,38,.6);color:#cfd5ef;display:grid;place-items:center;cursor:pointer}
    .tdai-ibtn:hover{color:var(--txt)}
    .tdai-send{display:inline-flex;gap:8px;align-items:center;padding:12px 18px;border-radius:12px;border:1px solid #33407a;
      background:linear-gradient(135deg,var(--brand),var(--acc));color:#0e1330;font-weight:600;cursor:pointer;
      box-shadow:0 8px 22px rgba(91,231,196,.18),0 8px 22px rgba(106,125,255,.18)}
    .tdai-hint{margin:6px 12px 0;color:#a7afc7;font-size:13px;text-align:center}
  </style>

  <div class="tdai-wrap">
    <div class="tdai-top">
      <div class="tdai-brand"><div class="tdai-logo">T</div><h1 class="tdai-title">TDAI</h1></div>
      <div class="tdai-pill"><span class="tdai-dot"></span><span>TDAI-6</span></div>
    </div>

    <div id="tdai-chat" class="tdai-chat" aria-live="polite">
      <div class="tdai-msg assistant">
        <div class="tdai-ava">IA</div>
        <div class="tdai-bub">Bienvenue sur TDAI ‚Äî la premi√®re IA con√ßue exclusivement pour les esprits TDAH.</div>
      </div>
    </div>

    <div id="tdai-previews" class="tdai-previews"></div>

    <div class="tdai-compose">
      <form id="tdai-form" class="tdai-inwrap" autocomplete="off">
        <textarea id="tdai-input" class="tdai-input" rows="1" placeholder="√âcris ton message‚Ä¶"></textarea>
        <div class="tdai-actions">
          <input type="file" id="tdai-file" accept="image/*" multiple hidden>
          <button type="button" class="tdai-ibtn" id="tdai-photo">üì∑</button>
          <button type="button" class="tdai-ibtn" id="tdai-clear">‚úï</button>
          <button type="submit" class="tdai-send" id="tdai-sendBtn">‚û§ <span>Envoyer</span></button>
        </div>
      </form>
      <div class="tdai-hint">Formats conseill√©s : JPG/PNG ‚Äî jusqu‚Äô√† 3 images par message</div>
    </div>
  </div>

  <script>
    const API_URL="https://tdah-ia.onrender.com/chat";
    const chatEl=document.getElementById("tdai-chat");
    const formEl=document.getElementById("tdai-form");
    const inputEl=document.getElementById("tdai-input");
    const clearEl=document.getElementById("tdai-clear");
    const sendBtn=document.getElementById("tdai-sendBtn");
    const fileBtn=document.getElementById("tdai-photo");
    const fileInput=document.getElementById("tdai-file");
    const previews=document.getElementById("tdai-previews");
    const composeEl = document.querySelector('.tdai-compose');
    let imagesData=[]; let pending=false;

    /* ‚Äî‚Äî‚Äî Barre fixe iPhone : on r√©serve l‚Äôespace et on reste scotch√© en bas ‚Äî‚Äî‚Äî */
    function padForComposer(){
      const h = composeEl?.getBoundingClientRect().height || 0;
      chatEl.style.paddingBottom = (h + 12) + 'px';
    }
    function scrollToBottom(){
      chatEl.scrollTo({ top: chatEl.scrollHeight, behavior: 'smooth' });
    }
    if (window.visualViewport){
      visualViewport.addEventListener('resize', () => { padForComposer(); scrollToBottom(); });
      visualViewport.addEventListener('scroll', padForComposer);
    }
    window.addEventListener('resize', padForComposer);
    window.addEventListener('orientationchange', padForComposer);
    inputEl.addEventListener('focus', () => setTimeout(() => { padForComposer(); scrollToBottom(); }, 50));
    inputEl.addEventListener('input', () => { padForComposer(); scrollToBottom(); });
    inputEl.addEventListener('blur', () => setTimeout(padForComposer, 100));
    padForComposer();

    function addMsg(role,text){
      const wrap=document.createElement("div");wrap.className="tdai-msg "+role;
      const ava=document.createElement("div");ava.className="tdai-ava";ava.textContent=role==="assistant"?"IA":""; /* pas de ‚ÄúToi‚Äù */
      const bub=document.createElement("div");bub.className="tdai-bub";bub.textContent=text;
      wrap.appendChild(ava);wrap.appendChild(bub);
      chatEl.appendChild(wrap);
      scrollToBottom(); padForComposer();
    }

    function autosize(el){el.style.height="auto";el.style.height=Math.min(el.scrollHeight,160)+"px";}
    inputEl.addEventListener("input",()=>autosize(inputEl));autosize(inputEl);

    fileBtn.addEventListener("click",()=>fileInput.click());
    fileInput.addEventListener("change",async e=>{
      const files=Array.from(e.target.files||[]);
      for(const f of files.slice(0,3-imagesData.length)){
        if(!f.type.startsWith("image/"))continue;
        const dataUrl=await new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(f);});
        imagesData.push(dataUrl);
      }
      renderPreviews();fileInput.value="";
    });

    function renderPreviews(){
      previews.innerHTML="";
      imagesData.forEach((url,i)=>{
        const box=document.createElement("div");box.className="tdai-thumb";
        const img=document.createElement("img");img.src=url;
        const x=document.createElement("button");x.className="tdai-x";x.textContent="√ó";
        x.onclick=()=>{imagesData.splice(i,1);renderPreviews();};
        box.appendChild(img);box.appendChild(x);
        previews.appendChild(box);
      });
    }

    formEl.addEventListener("submit",async e=>{
      e.preventDefault();
      const msg=inputEl.value.trim();
      if(pending) return;                  // anti double-envoi
      if(!msg && imagesData.length===0) return;

      if(msg) addMsg("user",msg);
      if(imagesData.length) addMsg("user",`[${imagesData.length} image(s) envoy√©e(s)]`);
      inputEl.value=""; autosize(inputEl); previews.innerHTML="";
      pending=true; sendBtn.disabled=true;

      try{
        const r=await fetch(API_URL,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({message:msg,images:imagesData})
        });
        imagesData=[];
        const data=await r.json().catch(()=>({}));

        if(!r.ok){
          const detail = (data && (data.error||data.detail)) ? ` (${data.error||data.detail})` : "";
          addMsg("assistant","Erreur serveur."+detail);
        }else{
          /* ‚úÖ g√®re answer | reply | choices */
          const reply = data.answer
            || data.reply
            || data.choices?.[0]?.message?.content
            || "‚Ä¶";
          addMsg("assistant", reply);
        }
      }catch(err){
        console.error(err);
        addMsg("assistant","Erreur r√©seau.");
      }finally{
        pending=false; sendBtn.disabled=false;
        padForComposer();
      }
    });

    inputEl.addEventListener("keydown",e=>{
      if(e.key==="Enter"&&!e.shiftKey){
        e.preventDefault();
        formEl.dispatchEvent(new Event("submit",{cancelable:true}));
      }
    });

    clearEl?.addEventListener("click",()=>{
      chatEl.innerHTML="";imagesData=[];previews.innerHTML="";
      addMsg("assistant","Nouvelle conversation. Texte ou photos : je t‚Äô√©coute.");
    });
  </script>
</div>

</body>
</html>
