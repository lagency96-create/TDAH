<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>TDAI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <style>
    /* Base */
    html,body{margin:0;padding:0;height:100%;background:#0c0f19;overflow:hidden;overscroll-behavior:none}
    :root{
      --safe-b: env(safe-area-inset-bottom,0px);
      --composer-h: 100px; /* mis Ã  jour en JS */
    }

    /* ThÃ¨me & layout */
    .tdai-app{
      --bg0:#0c0f19;--bg1:#0f1424;--bg2:#121831;--txt:#e9ebf3;--dim:#a7afc7;
      --brand:#6a7dff;--acc:#5be7c4;--br:#232a4d;--bubU:#0b2c55;--bubA:#161f3d;
      color:var(--txt);
      font:400 16px/1.6 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,var(--bg0)0%,var(--bg1)60%,var(--bg2)100%);
      width:100%;
      height:100svh;min-height:100svh;display:flex;
    }
    .tdai-wrap{flex:1;display:flex;flex-direction:column;min-height:0}

    /* Header */
    .tdai-top{
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      padding:12px 16px;border-bottom:1px solid var(--br);
      position:sticky;top:0;z-index:5;
      background:rgba(12,15,25,.9);backdrop-filter:saturate(120%) blur(8px)
    }
    .tdai-brand{display:flex;align-items:center;gap:10px}
    .tdai-logo{width:36px;height:36px;border-radius:9px;display:grid;place-items:center;font-weight:800;color:#0e1330;
      background:linear-gradient(135deg,var(--brand),var(--acc));box-shadow:0 6px 18px rgba(106,125,255,.35)}
    .tdai-title{margin:0;font-size:18px;font-weight:700}
    .tdai-pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--br);border-radius:999px;
      padding:6px 10px;background:rgba(20,26,52,.6);color:var(--txt);font-size:13px}
    .tdai-dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--acc));box-shadow:0 0 10px var(--acc)}

    /* Zone chat : seule zone qui scroll */
    .tdai-chat{
      flex:1;min-height:0;overflow:auto;-webkit-overflow-scrolling:touch;
      padding:16px;
      padding-bottom:calc(var(--composer-h) + 16px);
      scroll-behavior:smooth;
      touch-action:manipulation;
    }
    .tdai-chat::-webkit-scrollbar{width:10px}
    .tdai-chat::-webkit-scrollbar-thumb{background:#27315e;border-radius:999px}

    .tdai-msg{display:flex;gap:10px;margin:12px 0}
    .tdai-ava{flex:0 0 34px;height:34px;border-radius:8px;display:grid;place-items:center;font-size:12px;font-weight:700;color:#0f1424}
    .tdai-msg.assistant .tdai-ava{background:linear-gradient(135deg,var(--brand),var(--acc))}
    .tdai-msg.user .tdai-ava{display:none}
    .tdai-msg.assistant{justify-content:flex-start}
    .tdai-msg.user{justify-content:flex-end}
    .tdai-bub{
      background:var(--bubA);border:1px solid var(--br);border-radius:14px;padding:12px 14px;
      max-width:90%;word-wrap:break-word;white-space:pre-wrap;box-shadow:0 10px 30px rgba(0,0,0,.25);
      font-size:17px;line-height:1.7
    }
    .tdai-msg.user .tdai-bub{background:linear-gradient(180deg,var(--bubU),#0a2244);border-color:#1b3b72}

    /* Barre dâ€™Ã©criture â€” FIXE, dÃ©placÃ©e au-dessus du clavier via JS */
    .tdai-compose-outer{
      position:fixed;left:0;right:0;bottom:0;
      padding:10px 10px calc(10px + var(--safe-b));
      background:linear-gradient(180deg,rgba(12,15,25,0),rgba(12,15,25,.85));
      z-index:10;will-change:bottom;
    }
    .tdai-inwrap{
      display:flex;gap:10px;align-items:flex-end;
      background:rgba(20,26,52,.75);border:1px solid var(--br);
      border-radius:16px;padding:10px;box-shadow:0 10px 30px rgba(0,0,0,.35)
    }
    .tdai-input{
      flex:1;min-height:44px;max-height:160px;resize:none;border:0;outline:none;
      background:transparent;color:var(--txt);padding:6px 8px;font-size:16px
    }
    .tdai-actions{display:flex;gap:8px;align-items:center}
    .tdai-ibtn{width:40px;height:40px;border:1px solid var(--br);border-radius:12px;background:rgba(15,20,38,.6);color:#cfd5ef;display:grid;place-items:center;cursor:pointer}
    .tdai-ibtn:hover{color:var(--txt)}
    .tdai-send{display:inline-flex;gap:8px;align-items:center;padding:12px 18px;border-radius:12px;border:1px solid #33407a;
      background:linear-gradient(135deg,var(--brand),var(--acc));color:#0e1330;font-weight:600;cursor:pointer;
      box-shadow:0 8px 22px rgba(91,231,196,.18),0 8px 22px rgba(106,125,255,.18)}
    .tdai-hint{margin:6px 12px 0;color:var(--dim);font-size:13px;text-align:center}

    @media(max-width:768px){
      .tdai-title{font-size:18px}
      .tdai-bub{font-size:17px;line-height:1.7}
      .tdai-input{font-size:16px}
      .tdai-chat{padding:18px;padding-bottom:calc(var(--composer-h) + 18px)}
    }
  </style>
</head>
<body>

<div class="tdai-app">
  <div class="tdai-wrap">
    <div class="tdai-top">
      <div class="tdai-brand"><div class="tdai-logo">T</div><h1 class="tdai-title">TDAI</h1></div>
      <div class="tdai-pill"><span class="tdai-dot"></span><span>TDAI-6</span></div>
    </div>

    <div id="tdai-chat" class="tdai-chat" aria-live="polite">
      <div class="tdai-msg assistant">
        <div class="tdai-ava">IA</div>
        <div class="tdai-bub">Bienvenue sur TDAI â€” la premiÃ¨re IA conÃ§ue exclusivement pour les esprits TDAH.</div>
      </div>
    </div>
  </div>
</div>

<!-- Composer fixÃ© -->
<div id="tdai-compose-outer" class="tdai-compose-outer">
  <form id="tdai-form" class="tdai-inwrap" autocomplete="off">
    <textarea id="tdai-input" class="tdai-input" rows="1" placeholder="Ã‰cris ton messageâ€¦"></textarea>
    <div class="tdai-actions">
      <input type="file" id="tdai-file" accept="image/*" multiple hidden>
      <button type="button" class="tdai-ibtn" id="tdai-photo">ðŸ“·</button>
      <button type="button" class="tdai-ibtn" id="tdai-clear">âœ•</button>
      <button type="submit" class="tdai-send" id="tdai-sendBtn">âž¤ <span>Envoyer</span></button>
    </div>
  </form>
  <div class="tdai-hint">Formats conseillÃ©s : JPG/PNG â€” jusquâ€™Ã  3 images par message</div>
</div>

<script>
  /* Mesure de la barre + anti-sauts iOS (clavier & barre dâ€™URL) */
  const composeOuter = document.getElementById('tdai-compose-outer');
  const chatEl = document.getElementById('tdai-chat');

  function syncComposerSpace(){
    const h = composeOuter.getBoundingClientRect().height;
    document.documentElement.style.setProperty('--composer-h', h + 'px');
  }
  new ResizeObserver(syncComposerSpace).observe(composeOuter);
  syncComposerSpace();

  // DÃ©placement dynamique au-dessus du clavier / chrome iOS
  function updateForViewport(){
    if(!window.visualViewport){ return; }
    const vv = visualViewport;
    // espace â€œprisâ€ en bas par clavier + barre Safari
    const bottomGap = Math.max(0, (window.innerHeight - (vv.height + vv.offsetTop)));
    composeOuter.style.bottom = bottomGap + 'px';
    // garder la vue en bas (Ã©vite le saut Ã  chaque frappe)
    requestAnimationFrame(()=> chatEl.scrollTo({top: chatEl.scrollHeight, behavior:'instant'}));
  }
  if(window.visualViewport){
    visualViewport.addEventListener('resize', updateForViewport);
    visualViewport.addEventListener('scroll', updateForViewport);
  }
  updateForViewport();

  // Focus/blur : stabilisation supplÃ©mentaire (iOS)
  const inputEl = document.getElementById("tdai-input");
  inputEl.addEventListener('focus', ()=>{
    setTimeout(()=>{
      updateForViewport();
      chatEl.scrollTop = chatEl.scrollHeight;
    }, 50);
  });
  inputEl.addEventListener('blur', ()=>{
    composeOuter.style.bottom = '0px';
    syncComposerSpace();
  });

  /* ======= Chat logic ======= */
  const API_URL="https://tdah-ia.onrender.com/chat";
  const formEl=document.getElementById("tdai-form");
  const clearEl=document.getElementById("tdai-clear");
  const fileBtn=document.getElementById("tdai-photo");
  const fileInput=document.getElementById("tdai-file");
  let imagesData=[]; let pending=false;

  function addMsg(role,text){
    const wrap=document.createElement("div");wrap.className="tdai-msg "+role;
    if(role==="assistant"){
      const ava=document.createElement("div");ava.className="tdai-ava";ava.textContent="IA";
      wrap.appendChild(ava);
    }
    const bub=document.createElement("div");bub.className="tdai-bub";bub.textContent=text;
    wrap.appendChild(bub);
    chatEl.appendChild(wrap);
    chatEl.scrollTo({top:chatEl.scrollHeight,behavior:"smooth"});
  }

  function setPending(on){
    pending = on;
    const btn=document.getElementById("tdai-sendBtn");
    btn.disabled = on;
    if(on) addMsg("assistant","TDAI rÃ©flÃ©chitâ€¦");
  }

  // autosize
  function autosize(el){el.style.height="auto";el.style.height=Math.min(el.scrollHeight,160)+"px";}
  inputEl.addEventListener("input",()=>autosize(inputEl)); autosize(inputEl);

  // Images (optionnel)
  fileBtn.addEventListener("click",()=>fileInput.click());
  fileInput.addEventListener("change",async e=>{
    const files=Array.from(e.target.files||[]);
    for(const f of files.slice(0,3-imagesData.length)){
      if(!f.type.startsWith("image/"))continue;
      const dataUrl=await new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(f);});
      imagesData.push(dataUrl);
    }
    fileInput.value="";
  });

  // Envoi
  formEl.addEventListener("submit",async e=>{
    e.preventDefault();
    if(pending) return;
    const msg=inputEl.value.trim();
    if(!msg && imagesData.length===0) return;

    if(msg) addMsg("user",msg);
    if(imagesData.length){ addMsg("user",`[${imagesData.length} image(s)]`); }

    inputEl.value=""; autosize(inputEl);
    setPending(true);

    try{
      const r=await fetch(API_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({message:msg,images:imagesData})
      });
      imagesData=[];
      const data=await r.json().catch(()=>({}));
      const last = chatEl.querySelector('.tdai-msg.assistant:last-child .tdai-bub');
      if(last && last.textContent==="TDAI rÃ©flÃ©chitâ€¦") last.parentElement.parentElement.remove();

      if(r.ok && (data.reply || data.answer || data.choices)){
        const reply = data.reply || data.answer || (data.choices?.[0]?.message?.content) || "â€¦";
        addMsg("assistant",reply);
      }else{
        addMsg("assistant","Erreur, rÃ©essaie.");
      }
    }catch(err){
      const last = chatEl.querySelector('.tdai-msg.assistant:last-child .tdai-bub');
      if(last && last.textContent==="TDAI rÃ©flÃ©chitâ€¦") last.parentElement.parentElement.remove();
      addMsg("assistant","Erreur rÃ©seau.");
      console.error(err);
    }finally{
      setPending(false);
      // toujours recoller en bas
      chatEl.scrollTop = chatEl.scrollHeight;
    }
  });

  // EntrÃ©e rapide
  inputEl.addEventListener("keydown",e=>{
    if(e.key==="Enter"&&!e.shiftKey){
      e.preventDefault();
      formEl.dispatchEvent(new Event("submit",{cancelable:true}));
    }
  });

  // Reset
  clearEl.addEventListener("click",()=>{
    chatEl.innerHTML="";
    imagesData=[];
    addMsg("assistant","Nouvelle conversation. Texte ou photos : je tâ€™Ã©coute.");
  });

  // DÃ©marrage
  window.addEventListener('load', ()=> chatEl.scrollTop = chatEl.scrollHeight);
</script>
</body>
</html>
