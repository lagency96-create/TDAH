<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>TDAI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <style>
    :root{
      --bg0:#0c0f19;--bg1:#0f1424;--bg2:#121831;
      --txt:#e9ebf3;--dim:#a7afc7;--br:#232a4d;--brand:#6a7dff;--acc:#5be7c4;
      --safe-b:env(safe-area-inset-bottom,0px);
      --composer-h:140px;  /* sera recalculÃ© dynamiquement */
    }

    html,body{
      margin:0;padding:0;background:var(--bg0);color:var(--txt);
      font:400 16px/1.6 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-text-size-adjust:100%; text-size-adjust:100%;
      overflow:auto; overscroll-behavior-y:contain;
    }
    .tdai-app{
      min-height:100dvh; display:flex; flex-direction:column;
      background:linear-gradient(180deg,var(--bg0) 0%,var(--bg1) 60%,var(--bg2) 100%);
    }
    @supports(height:100svh){ .tdai-app{ min-height:100svh; } }

    /* Header */
    .tdai-top{
      position:sticky; top:0; z-index:5;
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      padding:12px 16px; border-bottom:1px solid var(--br);
      background:rgba(12,15,25,.9); backdrop-filter:saturate(120%) blur(8px);
    }
    .tdai-brand{display:flex;align-items:center;gap:10px}
    .tdai-logo{width:36px;height:36px;border-radius:9px;display:grid;place-items:center;font-weight:800;color:#0e1330;
      background:linear-gradient(135deg,var(--brand),var(--acc));box-shadow:0 6px 18px rgba(106,125,255,.35)}
    .tdai-title{margin:0;font-size:18px;font-weight:700}
    .tdai-pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--br);border-radius:999px;
      padding:6px 10px;background:rgba(20,26,52,.6);font-size:13px}
    .tdai-dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--acc));box-shadow:0 0 10px var(--acc)}

    /* Zone chat : padding-bottom = hauteur composer */
    .tdai-chat{
      padding:16px;
      padding-bottom:calc(var(--composer-h) + 16px + var(--safe-b));
      display:flex; flex-direction:column; gap:10px;
      scroll-behavior:smooth; -webkit-overflow-scrolling:touch; touch-action:pan-y;
    }

    .tdai-msg{display:flex; gap:10px; align-items:flex-end}
    .tdai-msg.assistant .tdai-bub{margin-right:auto}
    .tdai-msg.user .tdai-bub{margin-left:auto}
    .tdai-ava{flex:0 0 34px;height:34px;border-radius:8px;display:grid;place-items:center;font-size:12px;font-weight:700;color:#0f1424}
    .tdai-msg.assistant .tdai-ava{background:linear-gradient(135deg,var(--brand),var(--acc))}
    .tdai-msg.user .tdai-ava{display:none}
    .tdai-bub{
      background:#161f3d;border:1px solid var(--br);border-radius:14px;
      padding:12px 14px;max-width:90%;
      word-wrap:break-word;white-space:pre-wrap;
      box-shadow:0 10px 30px rgba(0,0,0,.25);font-size:17px;line-height:1.7;
    }
    .tdai-msg.user .tdai-bub{background:linear-gradient(180deg,#0b2c55,#0a2244);border-color:#1b3b72}

    .tdai-previews{display:flex;gap:8px;flex-wrap:wrap;margin:4px 12px}
    .tdai-thumb{position:relative;width:84px;height:84px;border:1px solid var(--br);border-radius:10px;overflow:hidden;background:#0e1530}
    .tdai-thumb img{width:100%;height:100%;object-fit:cover}
    .tdai-x{position:absolute;top:4px;right:4px;width:20px;height:20px;border-radius:50%;background:rgba(0,0,0,.55);color:#fff;border:0;cursor:pointer}

    /* Composer : par dÃ©faut STICKY (desktop/Android) */
    .tdai-compose{
      position:sticky; bottom:0; z-index:10;
      background:rgba(12,15,25,.96); backdrop-filter:blur(8px);
      padding:10px 10px calc(10px + var(--safe-b));
      box-shadow:0 -6px 24px rgba(0,0,0,.25);
      transform:translateZ(0); /* empÃªche les sauts sur iOS */
    }
    .tdai-inwrap{display:flex;gap:10px;align-items:flex-end;background:rgba(20,26,52,.75);border:1px solid var(--br);
      border-radius:16px;padding:10px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .tdai-input{flex:1;min-height:44px;max-height:160px;resize:none;border:0;outline:none;background:transparent;color:var(--txt);padding:6px 8px;font-size:16px}
    .tdai-actions{display:flex;gap:8px;align-items:center}
    .tdai-ibtn{width:40px;height:40px;border:1px solid var(--br);border-radius:12px;background:rgba(15,20,38,.6);color:#cfd5ef;display:grid;place-items:center;cursor:pointer}
    .tdai-send{display:inline-flex;gap:8px;align-items:center;padding:12px 18px;border-radius:12px;border:1px solid #33407a;
      background:linear-gradient(135deg,var(--brand),var(--acc));color:#0e1330;font-weight:600;cursor:pointer;
      box-shadow:0 8px 22px rgba(91,231,196,.18),0 8px 22px rgba(106,125,255,.18)}
    .tdai-hint{margin:6px 12px 0;color:var(--dim);font-size:13px;text-align:center}
  </style>
</head>
<body>
  <div class="tdai-app" id="app">
    <div class="tdai-top">
      <div class="tdai-brand"><div class="tdai-logo">T</div><h1 class="tdai-title">TDAI</h1></div>
      <div class="tdai-pill"><span class="tdai-dot"></span><span>TDAI-6</span></div>
    </div>

    <div id="tdai-chat" class="tdai-chat" aria-live="polite">
      <div class="tdai-msg assistant">
        <div class="tdai-ava">IA</div>
        <div class="tdai-bub">Bienvenue sur TDAI â€” la premiÃ¨re IA conÃ§ue exclusivement pour les esprits TDAH.</div>
      </div>
      <div id="tdai-bottom"></div>
    </div>

    <div id="tdai-previews" class="tdai-previews"></div>

    <div class="tdai-compose" id="tdai-compose">
      <form id="tdai-form" class="tdai-inwrap" autocomplete="off">
        <textarea id="tdai-input" class="tdai-input" rows="1" placeholder="Ã‰cris ton messageâ€¦"></textarea>
        <div class="tdai-actions">
          <input type="file" id="tdai-file" accept="image/*" multiple hidden>
          <button type="button" class="tdai-ibtn" id="tdai-photo">ðŸ“·</button>
          <button type="button" class="tdai-ibtn" id="tdai-clear">âœ•</button>
          <button type="submit" class="tdai-send" id="tdai-sendBtn">âž¤ <span>Envoyer</span></button>
        </div>
      </form>
      <div class="tdai-hint">Formats conseillÃ©s : JPG/PNG â€” jusquâ€™Ã  3 images par message</div>
    </div>
  </div>

  <script>
    const API_URL="https://tdah-ia.onrender.com/chat";

    const chatEl=document.getElementById('tdai-chat');
    const bottomEl=document.getElementById('tdai-bottom');
    const composeEl=document.getElementById('tdai-compose');
    const formEl=document.getElementById('tdai-form');
    const inputEl=document.getElementById('tdai-input');
    const sendBtn=document.getElementById('tdai-sendBtn');
    const clearEl=document.getElementById('tdai-clear');
    const fileBtn=document.getElementById('tdai-photo');
    const fileInput=document.getElementById('tdai-file');
    const previews=document.getElementById('tdai-previews');

    let imagesData=[]; let pending=false;

    /* ---------- iOS: composer en FIXED + suivi du clavier ---------- */
    const isIOS = /iP(hone|ad|od)/.test(navigator.userAgent);
    function applyIOSFix(){
      if(!isIOS) return;
      // place en fixed tout en bas (mieux que sticky sous iOS)
      Object.assign(composeEl.style,{
        position:'fixed', left:'0', right:'0', bottom:'0'
      });
      // ajuste avec visualViewport pour ne pas passer sous le clavier
      const vv = window.visualViewport;
      const onVV = () => {
        const vh = vv.height, vo = vv.offsetTop;        // espace visible
        const delta = (window.innerHeight - (vh + vo)); // ce qui est masquÃ© par le clavier
        composeEl.style.transform = `translateY(${-delta}px)`;
        sizeComposer(); // met Ã  jour le padding bas du chat
      };
      if(vv){ vv.addEventListener('resize', onVV); vv.addEventListener('scroll', onVV); onVV(); }
    }

    /* ---------- Mesure hauteur composer -> espace bas dans le chat ---------- */
    function sizeComposer(){
      const h = composeEl.getBoundingClientRect().height || 140;
      document.documentElement.style.setProperty('--composer-h', h+'px');
    }
    new ResizeObserver(sizeComposer).observe(composeEl);
    window.addEventListener('resize', sizeComposer);
    sizeComposer();
    applyIOSFix();

    /* ---------- Utilitaires dâ€™affichage ---------- */
    const scrollToBottom = () => requestAnimationFrame(()=>bottomEl.scrollIntoView({block:"end"}));
    new MutationObserver(scrollToBottom).observe(chatEl,{childList:true});

    function autosize(el){ el.style.height="auto"; el.style.height=Math.min(el.scrollHeight,160)+"px"; }
    autosize(inputEl);
    inputEl.addEventListener('input',()=>{ autosize(inputEl); scrollToBottom(); });

    function addMsg(role,text,id){
      const wrap=document.createElement("div");wrap.className="tdai-msg "+role; if(id) wrap.dataset.id=id;
      const ava=document.createElement("div");ava.className="tdai-ava";ava.textContent=(role==="assistant")?"IA":"";
      const bub=document.createElement("div");bub.className="tdai-bub";bub.textContent=text;
      if(role==="assistant"){ wrap.appendChild(ava); wrap.appendChild(bub); } else { wrap.appendChild(bub); }
      chatEl.insertBefore(wrap,bottomEl);
      return wrap;
    }
    function updateMsg(id,newText){
      const node=chatEl.querySelector(`.tdai-msg[data-id="${id}"] .tdai-bub`);
      if(node){ node.textContent=newText; }
    }

    /* ---------- Upload images (prÃ©views) ---------- */
    fileBtn.addEventListener("click",()=>fileInput.click());
    fileInput.addEventListener("change",async e=>{
      const files=Array.from(e.target.files||[]);
      for(const f of files.slice(0,3-imagesData.length)){
        if(!f.type.startsWith("image/"))continue;
        const dataUrl=await new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(f);});
        imagesData.push(dataUrl);
      }
      renderPreviews(); fileInput.value="";
    });
    function renderPreviews(){
      previews.innerHTML="";
      imagesData.forEach((url,i)=>{
        const box=document.createElement("div");box.className="tdai-thumb";
        const img=document.createElement("img");img.src=url;
        const x=document.createElement("button");x.className="tdai-x";x.textContent="Ã—";
        x.onclick=()=>{imagesData.splice(i,1);renderPreviews();};
        box.appendChild(img);box.appendChild(x);
        previews.appendChild(box);
      });
    }

    /* ---------- Envoi ---------- */
    formEl.addEventListener("submit",async e=>{
      e.preventDefault();
      if(pending) return;

      const msg=inputEl.value.trim();
      if(!msg && imagesData.length===0) return;

      if(msg) addMsg("user",msg);
      if(imagesData.length) addMsg("user",`[${imagesData.length} image(s) envoyÃ©e(s)]`);
      inputEl.value=""; autosize(inputEl); previews.innerHTML=""; scrollToBottom();

      const pid="p-"+Date.now();
      addMsg("assistant","TDAI rÃ©flÃ©chitâ€¦",pid);

      pending=true; sendBtn.disabled=true; inputEl.disabled=true;

      try{
        const r=await fetch(API_URL,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({message:msg,images:imagesData})
        });
        imagesData=[];
        let data={}; try{ data=await r.json(); }catch{ data={}; }
        if(!r.ok){
          const detail=(data && (data.error||data.detail))?` (${data.error||data.detail})`:"";
          updateMsg(pid,"Erreur serveur."+detail);
        }else{
          const reply=data.answer || data.reply || data.choices?.[0]?.message?.content || "â€¦";
          updateMsg(pid,reply);
        }
      }catch(err){
        updateMsg(pid,"Erreur rÃ©seau. RÃ©essaie.");
      }finally{
        pending=false; sendBtn.disabled=false; inputEl.disabled=false;
        scrollToBottom(); inputEl.focus({preventScroll:true});
      }
    });

    clearEl?.addEventListener("click",()=>{
      chatEl.innerHTML=""; chatEl.appendChild(bottomEl);
      imagesData=[]; previews.innerHTML="";
      addMsg("assistant","Nouvelle conversation. Texte ou photos : je tâ€™Ã©coute.");
      scrollToBottom();
    });
  </script>
</body>
</html>
